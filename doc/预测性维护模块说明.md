# 预测性维护模块（P0）说明文档

## 概述

预测性维护模块是基于RuoYi框架新增的功能模块，采用**方案A（通用资产：asset_type + asset_id）** 设计，通过分析设备的历史维护记录，使用规则引擎计算风险分数，生成可解释的预测结果，帮助运维人员提前发现潜在的设备故障风险。

### 版本信息

| 项目 | 说明 |
|------|------|
| 模块版本 | P0 |
| 模型版本 | RULE_P0_v1 |
| 创建时间 | 2026-01-13 |

---

## 功能特性

### P0 已实现功能

- ✅ 手动触发预测（按工厂/资产类型/资产范围）
- ✅ 生成并保存预测结果
- ✅ 预测结果列表与详情查询
- ✅ 结果处理流转（new → acknowledged → resolved / ignored）
- ✅ 详情页展示对应资产的历史维护记录
- ✅ 支持 equipment 和 device 两种资产类型

### P0 不包含（后续版本规划）

- ❌ 机器学习模型训练/部署
- ❌ WebSocket 实时推送
- ❌ 自动工单生成
- ❌ 效果评估指标（准确率等）
- ❌ 定时自动预测任务

---

## 数据库设计

### prediction_result 表

预测结果存储表，新增于本模块。

```sql
CREATE TABLE `prediction_result` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `factory_id` bigint DEFAULT NULL COMMENT '工厂ID',
  `asset_type` varchar(50) NOT NULL COMMENT '资产类型：equipment/device',
  `asset_id` bigint NOT NULL COMMENT '资产ID',
  `prediction_time` datetime NOT NULL COMMENT '预测生成时间',
  `risk_level` varchar(20) NOT NULL COMMENT '风险等级：low/medium/high',
  `risk_score` int NOT NULL DEFAULT 0 COMMENT '风险分数（0-100）',
  `reason_summary` varchar(500) DEFAULT NULL COMMENT '原因摘要',
  `reason_detail_json` text COMMENT '原因详情JSON（可解释）',
  `recommendation` text COMMENT '建议维护动作',
  `status` varchar(20) NOT NULL DEFAULT 'new' COMMENT '状态',
  `handled_by` varchar(100) DEFAULT NULL COMMENT '处理人',
  `handled_time` datetime DEFAULT NULL COMMENT '处理时间',
  `model_version` varchar(50) DEFAULT 'RULE_P0_v1' COMMENT '模型版本',
  -- 标准RuoYi字段
  `remark` varchar(500) DEFAULT NULL,
  `create_by` varchar(64) DEFAULT '',
  `create_time` datetime DEFAULT NULL,
  `update_by` varchar(64) DEFAULT '',
  `update_time` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  KEY `idx_asset` (`asset_type`, `asset_id`),
  KEY `idx_factory` (`factory_id`),
  KEY `idx_prediction_time` (`prediction_time`),
  KEY `idx_status` (`status`)
);
```

### 与现有表的关系

| 资产类型 | 关联表 | 关联字段 | 维护记录来源 |
|---------|--------|---------|-------------|
| equipment | equipment | equipment_id | maintenance_record.equipment_id |
| device | device | device_number | maintenance_record.equipment_id* |

> *注：当前数据库中 `maintenance_record.equipment_id` 实际存储的是 `device_number`

---

## 预测规则说明

### 评分规则（RULE_P0_v1）

P0 版本使用基于规则的预测引擎，通过分析维护记录的统计特征计算风险分数。

| 规则 | 名称 | 条件 | 贡献分 |
|------|------|------|--------|
| R1 | 距上次维护天数 | >90天: +40分<br>60-90天: +25分<br>30-60天: +10分<br>≤30天: +0分 | 0-40 |
| R2 | 近30天维护次数 | ≥3次: +35分<br>2次: +20分<br>1次: +8分<br>0次: +0分 | 0-35 |
| R3 | 近90天维护次数 | ≥6次: +25分<br>3-5次: +12分<br>0-2次: +0分 | 0-25 |
| R4 | 关键词命中 | 命中异常关键词: +15分<br>未命中: +0分 | 0-15 |

**关键词列表**：过热、异响、漏油、震动、报警、损坏、故障、异常

### 风险等级映射

| 风险分数 | 风险等级 | 建议处理时间 |
|---------|---------|-------------|
| ≥80 | 高风险（high） | 48小时内检查 |
| 50-79 | 中风险（medium） | 7天内巡检 |
| <50 | 低风险（low） | 纳入例行保养周期 |

### 原因详情 JSON 示例

```json
{
  "days_since_last": 72,
  "count_30d": 2,
  "count_90d": 4,
  "has_history": true,
  "rules": {
    "R1": {"name": "距上次维护天数", "value": 72, "score": 25, "threshold": "60-90天"},
    "R2": {"name": "近30天维护次数", "value": 2, "score": 20, "threshold": "2次"},
    "R3": {"name": "近90天维护次数", "value": 4, "score": 12, "threshold": "3-5次"},
    "R4": {"name": "关键词命中", "value": 0, "score": 0, "threshold": "未命中"}
  },
  "total_score": 57,
  "risk_level": "medium"
}
```

---

## 状态流转

预测结果支持以下状态流转：

```
        ┌─────────────────┐
        │      new        │  ← 新生成，待处理
        └────────┬────────┘
                 │
        ┌────────┴────────┐
        ▼                 ▼
┌───────────────┐  ┌───────────────┐
│  acknowledged │  │    ignored    │  ← 忽略/误报
│   （已确认）   │  └───────────────┘
└───────┬───────┘
        │
        ▼
┌───────────────┐
│   resolved    │  ← 已完成维护
└───────────────┘
```

| 操作 | 状态变更 | 说明 |
|------|---------|------|
| 确认 | new → acknowledged | 准备安排维护 |
| 忽略 | new/acknowledged → ignored | 误报或无需处理 |
| 完成 | acknowledged → resolved | 已完成维护 |

---

## API 接口

### 预测结果接口

| 方法 | 路径 | 权限 | 说明 |
|------|------|------|------|
| GET | `/predict/result/list` | predict:result:list | 分页查询预测结果 |
| GET | `/predict/result/{id}` | predict:result:view | 获取预测结果详情 |
| GET | `/predict/result/maintenance/{assetType}/{assetId}` | predict:result:view | 获取资产维护记录 |
| POST | `/predict/result/ack/{id}` | predict:result:handle | 确认预测结果 |
| POST | `/predict/result/ignore/{id}` | predict:result:handle | 忽略预测结果 |
| POST | `/predict/result/resolve/{id}` | predict:result:handle | 标记已完成 |
| DELETE | `/predict/result/{ids}` | predict:result:remove | 删除预测结果 |
| POST | `/predict/result/export` | predict:result:export | 导出预测结果 |

### 预测任务接口

| 方法 | 路径 | 权限 | 说明 |
|------|------|------|------|
| POST | `/predict/task/run` | predict:task:run | 运行预测任务 |

**请求参数**：
```json
{
  "assetType": "device",       // 资产类型：equipment/device
  "factoryId": 8,              // 工厂ID（可选）
  "assetIds": [17, 18, 19]     // 资产ID列表（可选）
}
```

**响应示例**：
```json
{
  "code": 200,
  "msg": "预测任务完成",
  "data": {
    "success": true,
    "message": "预测任务完成",
    "generatedCount": 14,
    "skippedCount": 0,
    "errorCount": 0,
    "duration": 156
  }
}
```

---

## 项目结构

### 后端代码

```
ruoyi-admin/src/main/java/com/ruoyi/predict/
├── controller/
│   ├── PredictionResultController.java    # 预测结果接口
│   └── PredictionTaskController.java      # 预测任务接口
├── domain/
│   └── PredictionResult.java              # 预测结果实体
├── mapper/
│   ├── PredictionResultMapper.java        # 预测结果Mapper
│   └── PredictEquipmentMapper.java        # 设备查询Mapper
└── service/
    ├── IPredictionResultService.java      # 预测结果服务接口
    ├── IPredictionEngineService.java      # 预测引擎服务接口
    └── impl/
        ├── PredictionResultServiceImpl.java   # 预测结果服务实现
        └── PredictionEngineServiceImpl.java   # 预测引擎服务实现

ruoyi-admin/src/main/resources/mapper/predict/
├── PredictionResultMapper.xml             # 预测结果SQL
└── PredictEquipmentMapper.xml             # 设备查询SQL
```

### 前端代码

```
ruoyi-ui/src/
├── api/predict/
│   ├── result.js              # 预测结果API
│   └── task.js                # 预测任务API
└── views/predict/
    ├── result/
    │   └── index.vue          # 预测结果列表页
    └── task/
        └── index.vue          # 手动预测页面
```

### SQL 脚本

```
sql/
└── predict_p0.sql             # 建表与菜单配置
```

---

## 使用指南

### 1. 执行 SQL 脚本

首次部署时需要执行 SQL 脚本创建表和菜单：

```bash
mysql -uroot -p123456 ry-vue < sql/predict_p0.sql
```

### 2. 重启后端服务

```bash
./start.sh
```

### 3. 运行预测

1. 登录系统，进入 **预测性维护 → 手动预测**
2. 选择资产类型（推荐选择 `device`）
3. 可选：指定工厂范围或资产ID
4. 点击 **运行预测**
5. 查看执行结果，点击 **查看预测结果** 跳转到结果列表

### 4. 处理预测结果

1. 进入 **预测性维护 → 预测结果**
2. 使用筛选条件查找需要处理的结果
3. 点击 **详情** 查看风险分析和历史维护记录
4. 根据实际情况执行 **确认/忽略/完成** 操作

---

## 权限配置

| 权限标识 | 说明 |
|---------|------|
| predict:result:list | 查询预测结果列表 |
| predict:result:query | 查询预测结果详情 |
| predict:result:view | 查看预测结果 |
| predict:result:handle | 处理预测结果（确认/忽略/完成） |
| predict:result:remove | 删除预测结果 |
| predict:result:export | 导出预测结果 |
| predict:task:run | 运行预测任务 |

---

## 注意事项

1. **每日去重**：同一资产每天只会生成一条预测记录，重复运行会自动跳过
2. **维护记录关联**：当前 `maintenance_record.equipment_id` 字段实际存储的是 `device_number`
3. **无历史数据处理**：如果资产没有维护记录，仍会生成低风险结果，建议补录巡检记录
4. **不修改现有表**：本模块不修改 `maintenance_record` 等现有表结构

---

## 后续规划

| 版本 | 功能 | 状态 |
|------|------|------|
| P0 | 规则引擎预测 | ✅ 已完成 |
| P1 | 定时自动预测 | 📋 规划中 |
| P1 | 关键词配置化 | 📋 规划中 |
| P2 | 机器学习模型 | 📋 规划中 |
| P2 | 自动工单生成 | 📋 规划中 |

---

## 技术支持

如有问题，请联系开发团队。
